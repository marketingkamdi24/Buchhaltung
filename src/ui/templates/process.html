{% extends "base.html" %}

{% block title %}Process Data{% endblock %}

{% block page_title %}
<i class="bi bi-gear-wide-connected"></i>
Data Processing
{% endblock %}

{% block content %}
<div class="process-wizard">
    <!-- Progress Header -->
    <div class="wizard-progress mb-4">
        <div class="progress-track">
            <div class="progress-step active" data-step="1">
                <div class="step-circle">
                    <i class="bi bi-cloud-download"></i>
                </div>
                <span class="step-label">Fetch API Data</span>
            </div>
            <div class="progress-connector">
                <div class="connector-line" id="connector-1"></div>
            </div>
            <div class="progress-step" data-step="2" id="step-2-indicator">
                <div class="step-circle">
                    <i class="bi bi-file-earmark-spreadsheet"></i>
                </div>
                <span class="step-label">Process Excel</span>
            </div>
            <div class="progress-connector">
                <div class="connector-line" id="connector-2"></div>
            </div>
            <div class="progress-step" data-step="3" id="step-3-indicator">
                <div class="step-circle">
                    <i class="bi bi-check-lg"></i>
                </div>
                <span class="step-label">Download</span>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="wizard-content">
        <!-- Step 1: Fetch API Data -->
        <div class="wizard-step active" id="step-1">
            <div class="card wizard-card">
                <div class="card-body">
                    <div class="step-header">
                        <div class="step-icon bg-primary-subtle text-primary">
                            <i class="bi bi-cloud-download"></i>
                        </div>
                        <div>
                            <h4>Fetch Transaction Data</h4>
                            <p class="text-muted mb-0">Download transaction data from eBay and Amazon APIs</p>
                        </div>
                    </div>
                    
                    <form id="fetch-form" class="mt-4">
                        <!-- Quick Date Selection -->
                        <div class="quick-dates mb-4">
                            <label class="form-label fw-medium">Date Range</label>
                            <div class="date-input-group">
                                <div class="input-with-icon">
                                    <i class="bi bi-calendar3"></i>
                                    <input type="text" class="form-control" id="date_from" 
                                           placeholder="From: DD.MM.YYYY" value="21.10.2025">
                                </div>
                                <span class="date-separator">to</span>
                                <div class="input-with-icon">
                                    <i class="bi bi-calendar3"></i>
                                    <input type="text" class="form-control" id="date_to" 
                                           placeholder="To: DD.MM.YYYY" value="28.10.2025">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Platform Toggle -->
                        <div class="platform-selection mb-4">
                            <label class="form-label fw-medium">Platforms</label>
                            <div class="platform-toggles">
                                <label class="platform-toggle amazon">
                                    <input type="checkbox" id="use_amazon" checked>
                                    <span class="toggle-content">
                                        <i class="bi bi-box-fill"></i>
                                        <span>Amazon</span>
                                    </span>
                                </label>
                                <label class="platform-toggle ebay">
                                    <input type="checkbox" id="use_ebay" checked>
                                    <span class="toggle-content">
                                        <i class="bi bi-bag-fill"></i>
                                        <span>eBay</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Optional: Custom Origins (collapsed by default) -->
                        <details class="custom-origins-section mb-4">
                            <summary class="text-muted small">
                                <i class="bi bi-plus-circle me-1"></i>Add custom origins
                            </summary>
                            <div class="mt-2">
                                <input type="text" class="form-control form-control-sm" 
                                       id="custom_origins" placeholder="e.g., Kaufland, MediaMarkt">
                            </div>
                        </details>
                        
                        <!-- Fetch Button -->
                        <button type="submit" class="btn btn-primary btn-lg w-100" id="fetch-btn">
                            <i class="bi bi-cloud-download me-2"></i>Fetch Data
                        </button>
                    </form>
                    
                    <!-- Fetch Result -->
                    <div id="fetch-result" class="result-panel mt-4" style="display: none;">
                        <div class="result-success">
                            <div class="result-icon">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <div class="result-info">
                                <h5>Data Retrieved Successfully</h5>
                                <p class="mb-0">
                                    <span id="fetch-count" class="fw-bold text-primary">0</span> records loaded
                                </p>
                            </div>
                            <button type="button" class="btn btn-success" id="continue-to-step-2">
                                Continue <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Fetch Error -->
                    <div id="fetch-error" class="alert alert-danger mt-4" style="display: none;">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="fetch-error-msg"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Upload & Process -->
        <div class="wizard-step" id="step-2">
            <div class="card wizard-card">
                <div class="card-body">
                    <div class="step-header">
                        <div class="step-icon bg-success-subtle text-success">
                            <i class="bi bi-file-earmark-spreadsheet"></i>
                        </div>
                        <div>
                            <h4>Process Shop Export</h4>
                            <p class="text-muted mb-0">Upload your eBay shop export and match with API data</p>
                        </div>
                    </div>
                    
                    <!-- API Data Status Badge -->
                    <div class="api-data-badge mt-4" id="api-data-badge">
                        <i class="bi bi-database-check"></i>
                        <span><span id="api-record-count">0</span> API records ready for matching</span>
                    </div>
                    
                    <!-- File Upload -->
                    <div class="file-upload-area mt-4" id="upload-area">
                        <input type="file" id="shop-file" accept=".xlsx,.xls,.csv" hidden>
                        <div class="upload-placeholder" id="upload-placeholder">
                            <div class="upload-icon-wrapper">
                                <i class="bi bi-cloud-upload"></i>
                            </div>
                            <h5>Drop your Excel file here</h5>
                            <p class="text-muted">or click to browse</p>
                            <span class="file-types">.xlsx, .xls, .csv</span>
                        </div>
                        <div class="upload-file-selected" id="upload-selected" style="display: none;">
                            <div class="file-icon">
                                <i class="bi bi-file-earmark-excel"></i>
                            </div>
                            <div class="file-details">
                                <span class="file-name" id="selected-file-name"></span>
                                <span class="file-size" id="selected-file-size"></span>
                            </div>
                            <button type="button" class="btn btn-link text-danger" id="remove-file">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Process Button -->
                    <button type="button" class="btn btn-success btn-lg w-100 mt-4" id="process-btn" disabled>
                        <i class="bi bi-gear me-2"></i>Match & Process
                    </button>
                    
                    <!-- Processing Indicator -->
                    <div id="processing-indicator" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-success mb-2"></div>
                        <p class="text-muted mb-0">Processing your file...</p>
                    </div>
                    
                    <!-- Back button -->
                    <button type="button" class="btn btn-link text-muted mt-3" id="back-to-step-1">
                        <i class="bi bi-arrow-left me-1"></i>Back to Step 1
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Results & Download -->
        <div class="wizard-step" id="step-3">
            <div class="card wizard-card">
                <div class="card-body">
                    <div class="step-header">
                        <div class="step-icon bg-success text-white">
                            <i class="bi bi-check-lg"></i>
                        </div>
                        <div>
                            <h4>Processing Complete!</h4>
                            <p class="text-muted mb-0">Your files are ready for download</p>
                        </div>
                    </div>
                    
                    <!-- Results Summary -->
                    <div class="results-summary mt-4">
                        <div class="result-stat-card">
                            <div class="stat-value text-success" id="result-matched">0</div>
                            <div class="stat-label">Matched</div>
                        </div>
                        <div class="result-stat-card">
                            <div class="stat-value text-warning" id="result-unmatched">0</div>
                            <div class="stat-label">Unmatched</div>
                        </div>
                        <div class="result-stat-card">
                            <div class="stat-value text-primary" id="result-total">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                    
                    <!-- Download Buttons -->
                    <div class="download-actions mt-4">
                        <a href="#" class="btn btn-primary btn-lg" id="download-modified">
                            <i class="bi bi-download me-2"></i>Download Processed File
                        </a>
                        <a href="#" class="btn btn-outline-secondary" id="download-matched">
                            <i class="bi bi-download me-2"></i>Download Matched Only
                        </a>
                    </div>
                    
                    <!-- Process Another -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-link" id="process-another">
                            <i class="bi bi-arrow-repeat me-1"></i>Process Another File
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedFile = null;
    let hasApiData = false;
    let apiRecordCount = 0;
    let currentStep = 1;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        checkApiData();
        setupFileUpload();
        setupNavigation();
    });
    
    // Check API data status
    async function checkApiData() {
        try {
            const response = await fetch('/api/check-api-data');
            const result = await response.json();
            hasApiData = result.has_data;
            apiRecordCount = result.record_count || 0;
            
            if (hasApiData) {
                document.getElementById('api-record-count').textContent = apiRecordCount.toLocaleString();
                document.getElementById('fetch-count').textContent = apiRecordCount.toLocaleString();
                document.getElementById('fetch-result').style.display = 'block';
                updateStepIndicator(1, 'completed');
            }
            updateProcessButton();
        } catch (error) {
            console.error('Error checking API data:', error);
        }
    }
    
    // Setup file upload
    function setupFileUpload() {
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('shop-file');
        
        uploadArea.addEventListener('click', (e) => {
            if (!e.target.closest('#remove-file')) {
                fileInput.click();
            }
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFile(fileInput.files[0]);
            }
        });
        
        document.getElementById('remove-file').addEventListener('click', (e) => {
            e.stopPropagation();
            clearFile();
        });
    }
    
    function handleFile(file) {
        if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
            showToast('error', 'Please upload an Excel or CSV file');
            return;
        }
        
        selectedFile = file;
        document.getElementById('selected-file-name').textContent = file.name;
        document.getElementById('selected-file-size').textContent = formatFileSize(file.size);
        document.getElementById('upload-placeholder').style.display = 'none';
        document.getElementById('upload-selected').style.display = 'flex';
        updateProcessButton();
    }
    
    function clearFile() {
        selectedFile = null;
        document.getElementById('shop-file').value = '';
        document.getElementById('upload-placeholder').style.display = 'block';
        document.getElementById('upload-selected').style.display = 'none';
        updateProcessButton();
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function updateProcessButton() {
        const btn = document.getElementById('process-btn');
        btn.disabled = !hasApiData || !selectedFile;
    }
    
    // Navigation
    function setupNavigation() {
        document.getElementById('continue-to-step-2').addEventListener('click', () => goToStep(2));
        document.getElementById('back-to-step-1').addEventListener('click', () => goToStep(1));
        document.getElementById('process-another').addEventListener('click', resetWizard);
    }
    
    function goToStep(step) {
        currentStep = step;
        document.querySelectorAll('.wizard-step').forEach((el, index) => {
            el.classList.toggle('active', index + 1 === step);
        });
        
        // Update progress indicators
        document.querySelectorAll('.progress-step').forEach((el) => {
            const stepNum = parseInt(el.dataset.step);
            el.classList.toggle('active', stepNum === step);
        });
    }
    
    function updateStepIndicator(step, status) {
        const stepEl = document.querySelector(`.progress-step[data-step="${step}"]`);
        const connectorEl = document.getElementById(`connector-${step}`);
        
        if (status === 'completed') {
            stepEl.classList.add('completed');
            if (connectorEl) connectorEl.classList.add('filled');
        }
    }
    
    function resetWizard() {
        currentStep = 1;
        clearFile();
        document.querySelectorAll('.wizard-step').forEach((el, index) => {
            el.classList.toggle('active', index === 0);
        });
        document.querySelectorAll('.progress-step').forEach((el) => {
            el.classList.remove('completed');
            el.classList.toggle('active', el.dataset.step === '1');
        });
        document.querySelectorAll('.connector-line').forEach(el => el.classList.remove('filled'));
        
        // Keep API data status
        if (hasApiData) {
            updateStepIndicator(1, 'completed');
        }
    }
    
    // Fetch API Data
    document.getElementById('fetch-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('fetch-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Fetching...';
        
        document.getElementById('fetch-result').style.display = 'none';
        document.getElementById('fetch-error').style.display = 'none';
        
        try {
            const response = await fetch('/api/fetch-data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    date_from: document.getElementById('date_from').value,
                    date_to: document.getElementById('date_to').value,
                    use_amazon: document.getElementById('use_amazon').checked,
                    use_ebay: document.getElementById('use_ebay').checked,
                    custom_origins: document.getElementById('custom_origins').value
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                hasApiData = true;
                apiRecordCount = data.record_count;
                document.getElementById('fetch-count').textContent = apiRecordCount.toLocaleString();
                document.getElementById('api-record-count').textContent = apiRecordCount.toLocaleString();
                document.getElementById('fetch-result').style.display = 'block';
                updateStepIndicator(1, 'completed');
                showToast('success', `Fetched ${data.record_count} records`);
            } else {
                document.getElementById('fetch-error-msg').textContent = data.message;
                document.getElementById('fetch-error').style.display = 'block';
                showToast('error', data.message);
            }
        } catch (error) {
            document.getElementById('fetch-error-msg').textContent = 'Network error: ' + error.message;
            document.getElementById('fetch-error').style.display = 'block';
            showToast('error', 'Failed to fetch data');
        }
        
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-download me-2"></i>Fetch Data';
        updateProcessButton();
    });
    
    // Process Data
    document.getElementById('process-btn').addEventListener('click', async function() {
        if (!selectedFile || !hasApiData) return;
        
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        document.getElementById('processing-indicator').style.display = 'block';
        
        const formData = new FormData();
        formData.append('shop_file', selectedFile);
        
        try {
            const response = await fetch('/api/process-data', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update results
                document.getElementById('result-matched').textContent = (data.matched_count || 0).toLocaleString();
                document.getElementById('result-unmatched').textContent = (data.unmatched_count || 0).toLocaleString();
                document.getElementById('result-total').textContent = (data.total_count || 0).toLocaleString();
                
                // Set download links
                if (data.modified_url) {
                    document.getElementById('download-modified').href = data.modified_url;
                }
                if (data.matched_url) {
                    document.getElementById('download-matched').href = data.matched_url;
                }
                
                updateStepIndicator(2, 'completed');
                goToStep(3);
                showToast('success', `Processed ${data.total_count} records`);
            } else {
                showToast('error', data.message);
            }
        } catch (error) {
            showToast('error', 'Failed to process data: ' + error.message);
        }
        
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-gear me-2"></i>Match & Process';
        document.getElementById('processing-indicator').style.display = 'none';
        updateProcessButton();
    });
</script>
{% endblock %}